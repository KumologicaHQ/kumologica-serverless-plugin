# Serverless plugin for Kumologica

This is serverless plugin that allows deployment of kumologica flow into aws account.

## Installation

**Install latest Npm and NodeJs**

Follow instructions from [get-npm](https://www.npmjs.com/get-npm)

**Install the Serverless Framework**

Follow instructions from [Get started with Serverless Framework Open Source & AWS](https://serverless.com/framework/docs/getting-started/)
 
**Install kumologica-serverless plugin**

Once serverless framework has been installed, run the following command in your terminal:
``` bash
serverless plugin install --name kumologica-serverless
```
Successful installation should produce output similar to below:
```
TODO: add output here
```

## Sample project

Create new kumologica project with hello world flow:

``` bash
sls create --template-url https://github.com/KumologicaHQ/serverless-templates/tree/master/helloworld-api --path helloworld-api
```
This will create new directory: helloworld-api with following files:
- hello-world-flow.json
- package.json
- serverless.yml

## Deployment

**IAM Role Policies**

Before deployment to aws, add events into serverless.yml as you would do for aws lambda. Sample project
has api gateway /hello defined. If you edited flow and implemented your own logic, this event is most likely not needed and should be removed from serverless.yml file.

Kumologica flow may interact with several aws services. In such a case correct permissions must be added to policies that are assigned to lambda's role.
If flow has ARNs of all aws resources provided in nodes properties, or nodes properties are referencing those ARNs via lambda's environment properties then kumologica-serverless plugin may automatically update those policies during deployment. To enable policies update add custom property inferIamPolicies into serverless.yml file and set it to true:

``` yaml
custom:
   kumologica:
     inferIamPolicies: true # false by default
```

If flow has references to ARNs using variables or message then it is not possible to determine their values at deploy time. In those scenarios it is necessary to specify those resources and actions in serverless.yml file.

**Test cases**

Komologica flow is internally divided into two sections: main and test. The test section should contain test cases and are not needed for correctly running flow in aws account.
To remove test related nodes from flow during deployment use excludeTest custom property in serverless.yml and set it to true. The kumologica-serverless plugin will remove test nodes from flow during deployment:

``` yaml
custom:
   kumologica:
    excludeTest: true      # false by default
```

## Deployment

To deploy flow into aws account use serverless deploy command, for example:

``` bash
sls deploy --aws-profile {aws profile} --region {aws region}
```

kumologica-serverless plugin is generating lambda file and runs npm install command during deployment.

## Testing 

To run flow locally:
``` bash
sls invoke -f helloworld-flow
```

## Cleanup

To remove flow from aws account use serverless remove command:

``` bash
sls remove
```

## Other Useful Commands

To see cloudformation scripts generated by serverless and kumologica-serverless plugin run:

``` bash
sls package -v
```
## Complete serverless.yml sample

Below is a complete serverless.yml file generated by kumologica serverless template:

``` yaml
service: hello-world

provider:
  name: aws
  runtime: nodejs12.x

functions:
  demo-flow: # name of your flow file (without .json extension)
    events:
      - http:
          path: hello
          method: get

custom:
   kumologica:
     inferIamPolicies: true # false by default
     excludeTest: true      # false by default

plugins:
  - kumologica-serverless

```
